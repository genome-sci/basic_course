# シェルスクリプトとバッチジョブ
#### 国立遺伝学研究所　森宙史

### シェルスクリプトとは?

- UNIXのコマンドを、実行してほしい一連の処理を実現できるように順番に並べたもの  
- **変数**や**配列**等の基本的なデータ構造を使うことが可能  
- **bash**や**zch**などの様々な派生シェル（機能や文法等が異なる）が存在する  
（なので、どのシェルでスクリプトを書くのか注意する必要がある）
- **for文**や**if文**等の基礎的なプログラミングの文法が使える  
(簡易的なものなので、本格的にプログラミングしたいなら、Python等のスクリプト言語を習得すべき)  
なお、Pythonの学習には、今年度の中級者講習会の[資料](https://github.com/genome-sci/python_bioinfo_2018)がオススメ  
　    
### シェルスクリプトの欠点

- データ構造が配列等の基本的なものしかない  
- コードの可読性に難あり  
（例: ワンライナー (シェル芸)、特にsedやawkやパイプが組み合わさると解読困難に)  
　  
### なぜシェルスクリプトを学ぶ?

- バイオインフォマティクスの解析では、同じ処理を多数のファイルに対して行うことが多い  
- 特にNGSデータは個々のファイルサイズが大きく各処理に時間がかかるので自動化が重要  
(例: 1run 8サンプルの8 x 2 fastqファイルの処理)  
- 遺伝研スパコン含め大抵のスパコンは、計算を投げるマシンと計算を実行するマシンが別であり、そのようなマシンを使うためにはシェルスクリプトの習得が必須  

これからの実習で重要な、遺伝研スパコン上でのシェルスクリプトファイルの編集方法 [(谷澤さんのFileZillaの使い方の解説)](https://www.evernote.com/l/AM3SRVwG6eJLDZojqTgWS_x5csynKJpbI0o)  
　  

### シェルスクリプトの例

1. FileZillaで遺伝研スパコンのホームディレクトリ上に、下記のtimes1.shファイルを作成

times1.sh
```
#!/bin/bash
date
sleep 7
date
```

2. TeraTerm or ターミナル等を用いてsshで遺伝研スパコンにログインし、qlogin後、下記のコマンドを実行  
`chmod u+x times1.sh`  
`./times1.sh`  

3. コードの解説
`#!/bin/bash` は、bashシェルを用いると指定する役割  
`date` は、今の日時を表示  
`sleep 7`は7秒間待つ  
`chmod u+x`は続くファイルの実行権限を自分自身に与える  
　  
### 変数

変数とは、プログラム内で繰り返し使う数値や文字列の入れ物  

1. FileZillaで遺伝研スパコンのホームディレクトリ上に、下記のtimes2.shファイルを作成

times2.sh
```
#!/bin/bash
v=7
date
sleep ${v}
f=`date`
echo ${f}
```

2. 遺伝研スパコン上で下記のコマンドを実行  
`chmod u+x times2.sh`  
`./times2.sh`  

3. コードの解説  
`v=7` は、変数vに7を代入。変数の定義では=の前後にスペースを入れない。値の代入時には$や{}は不要。代入する値は文字列でも数値でも良い。 
`${v}` は、変数の中身を展開する  
``f= `date` `` は、バッククオートの中身のUNIXコマンド(date)を実行した結果を、変数fに代入  
`echo`は続く変数や文字列等をコマンドライン上に表示  
　  
### 特殊変数

特殊変数とは、シェルによって最初から用途が予約されている特別な変数  

1. FileZillaで遺伝研スパコンのホームディレクトリ上に、下記のtimes3.shファイルを作成

times3.sh
```
#!/bin/bash
date
echo "You specified $# variable(s)."
sleep $1
date
```

2. 遺伝研スパコン上で下記のコマンドを実行  
`chmod u+x times3.sh`  
`./times3.sh 7`

3. コードの解説  
`$1` は、1番目の引数を意味する  
`$#` は、引数の数を意味する  
　  
### if文

if文とは、条件式の結果に依存して処理を分岐する文法  

1. FileZillaで遺伝研スパコンのホームディレクトリ上に、下記のtimes4.shファイルを作成

times4.sh
```
#!/bin/bash
date
if [ $# -ne 1 ]; then
  echo "You specified $# arguments, but this program can only use 1 argument."
  exit
fi
sleep $1
date
```

2. 遺伝研スパコン上で下記のコマンドを実行  
`chmod u+x times4.sh`  
`./times4.sh`  

3. コードの解説  
`if;then`は、ifの後の条件式の結果が真ならthen以降fiまでの処理を実行、偽ならfi以降の処理まで飛ぶ  
`[ 条件式 ]` は、`[]`と条件式の間にはスペースが必要   
`-ne` は、前後で数値比較を行い、値が異なっていたら真を返す。値が同じであれば偽を返す  
`exit`は、スクリプトの処理を終了する  
thenからfiまでの2行の行等に2スペース入れたが、見栄え以外で特に意味はない  
　  
### for文

for文とは、繰り返し処理に使える文法   

1. FileZillaで遺伝研スパコンのホームディレクトリ上に、下記のec1.shファイルを作成

ec1.sh
```
#!/bin/bash
for i in 1 2 a b
do
  echo ${i}
done
```

2. 遺伝研スパコン上で下記のコマンドを実行  
`chmod u+x ec1.sh`  
`./ec1.sh`  

3. コードの解説  
`for i in 1 2 a b` は、変数iに1,2,a,bを順に代入し、doからdoneまでの処理をその都度実行  
echoの前に2スペース入れたが、if文と同様、　見栄え以外で特に意味はない  
`for i in *.fastq` のようにファイル名をワイルドカードで指定すると、その条件にあてはまったファイル全てを処理してくれるので大変便利  
　  
### 配列

配列とは、数値や文字列の集合をまとめて扱うデータ構造   

1. FileZillaで遺伝研スパコンのホームディレクトリ上に、下記のec2.shファイルを作成

ec2.sh
```
#!/bin/bash
hoge=(1 2 a b)
echo ${hoge[0]}
echo ${hoge[@]}
echo ${hoge[$1]}
```

2. 遺伝研スパコン上で下記のコマンドを実行  
`chmod u+x ec2.sh`  
`./ec2.sh 3`  

3. コードの解説  
`hoge=(1 2 a b)` は、配列hogeに1,2,a,bをまとめて代入  
`${hoge[0]}` は、配列hogeの0番目の値を表示  
`${hoge[@]}` は、配列hogeの全ての値を表示  
`${hoge[$1]}` は、配列hogeの引数1個目で指定された値を表示  
　  
### コメントと改行

#以降はプログラムとしては無視される  
\後に改行すると、プログラム中ではその改行は無かったことにされる   

1. FileZillaで遺伝研スパコンのホームディレクトリ上に、下記のec3.shファイルを作成

ec3.sh
```
#!/bin/bash
date
sleep $1 #$1 is a specific value
date
echo \
$1
```

2. 遺伝研スパコン上で下記のコマンドを実行  
`chmod u+x ec3.sh`  
`./ec3.sh 7`  
　  
### シェルスクリプトを詳しく学ぶには
[UNIX & Linuxコマンド・シェルスクリプト リファレンス](https://shellscript.sunone.me/)が個人的にオススメ  
