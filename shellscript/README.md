# シェルスクリプトとバッチジョブ
#### 国立遺伝学研究所　森宙史

### シェルスクリプトとは?

- UNIXのコマンドを、実行してほしい一連の処理を実現できるように順番に並べたもの  
- **変数**や**配列**等の基本的なデータ構造を使うことが可能  
- **bash**や**zch**などの様々な派生シェル（機能や文法等が異なる）が存在する  
（なので、どのシェルでスクリプトを書くのか注意する必要がある）
- **for文**や**if文**等の基礎的なプログラミングの文法が使える  
(簡易的なものなので、本格的にプログラミングしたいなら、Python等のスクリプト言語を習得すべき)  
なお、Pythonの学習には、今年度の中級者講習会の[資料](https://github.com/genome-sci/python_bioinfo_2018)がオススメ  
  
### シェルスクリプトの欠点

- データ構造が配列等の基本的なものしかない  
- コードの可読性に難あり  
（例: ワンライナー (シェル芸)、特にsedやawkやパイプが組み合わさると解読困難に) 

### なぜシェルスクリプトを学ぶ?

- バイオインフォマティクスの解析では、同じ処理を多数のファイルに対して行うことが多い  
- 特にNGSデータは個々のファイルサイズが大きく各処理に時間がかかるので自動化が重要  
(例: 1run 8サンプルの8 x 2 fastqファイルの処理)  
- 遺伝研スパコン含め大抵のスパコンは、計算を投げるマシンと計算を実行するマシンが別であり、そのようなマシンを使うためにはシェルスクリプトの習得が必須  

これからの実習で重要な、遺伝研スパコン上でのシェルスクリプトファイルの編集方法 [(谷澤さんのFileZillaの使い方の解説)](https://www.evernote.com/l/AM3SRVwG6eJLDZojqTgWS_x5csynKJpbI0o)  

### シェルスクリプトの例

1. FileZillaで遺伝研スパコンのホームディレクトリ上に、下記のtimes1.shファイルを作成

times1.sh
```
#!/bin/bash
date
sleep 7
date
```

2. TeraTerm or ターミナル等を用いてsshで遺伝研スパコンにログインし、qlogin後、下記のコマンドを実行  
`chmod u+x times1.sh`
`./times1.sh`

3. コードの解説
`#!/bin/bash` は、bashシェルを用いると指定する役割  
`date` は、今の日時を表示  
`sleep 7`は7秒間待つ  
`chmod u+x`は続くファイルの実行権限を自分自身に与える  

### 変数

変数とは、プログラム内で繰り返し使う数値や文字列の入れ物  

1. FileZillaで遺伝研スパコンのホームディレクトリ上に、下記のtimes2.shファイルを作成

times2.sh
```
#!/bin/bash
v=7
date
sleep ${v}
f=`date`
echo ${f}
```

2. 遺伝研スパコン上で下記のコマンドを実行  
`chmod u+x times2.sh`
`./times2.sh`

3. コードの解説  
`v=7` は、変数vに7を代入。変数の定義では=の前後にスペースを入れない。値の代入時には$や{}は不要。代入する値は文字列でも数値でも良い。 
`${v}` は、変数の中身を展開する  
``f= `date` `` は、バッククオートの中身のUNIXコマンド(date)を実行した結果を、変数fに代入  
`echo`は続く変数や文字列等をコマンドライン上に表示  

### 特殊変数

特殊変数とは、シェルによって最初から用途が予約されている特別な変数  

1. FileZillaで遺伝研スパコンのホームディレクトリ上に、下記のtimes3.shファイルを作成

times3.sh
```
#!/bin/bash
date
echo "You specified $# variable(s)."
sleep $1
date
```

2. 遺伝研スパコン上で下記のコマンドを実行  
`chmod u+x times3.sh`  
`./times3.sh 7`

3. コードの解説  
`$1` は、1番目の引数を意味する  
`$#` は、引数の数を意味する

### if文

特殊変数とは、シェルによって最初から用途が予約されている特別な変数  

1. FileZillaで遺伝研スパコンのホームディレクトリ上に、下記のtimes3.shファイルを作成

times3.sh
```
#!/bin/bash
date
echo "You specified $# variable(s)."
sleep $1
date
```

2. 遺伝研スパコン上で下記のコマンドを実行  
`chmod u+x times3.sh`  
`./times3.sh 7`

3. コードの解説  
`$1` は、1番目の引数を意味する  
`$#` は、引数の数を意味する
